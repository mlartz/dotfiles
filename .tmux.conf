# Tmux Configuration File
# =====================
# Optimized for iTerm2 + tmux Control Mode
# This configuration enables native macOS window behavior while maintaining
# session persistence and tmux power features.

# Prefix Key Configuration
# ------------------------
# Unbind the default prefix key (Ctrl-b)
unbind-key C-b

# Set the prefix key to Ctrl-\ (more ergonomic and less likely to conflict with other tools)
set-option -g prefix 'C-\'

# Allow sending the prefix key to nested tmux sessions by pressing it twice
bind-key 'C-\' send-prefix


# Emacs/Vim Compatibility
# ------------------------
# Fix delay when pressing ESC in Emacs/Vim (essential for modal editing)
set -sg escape-time 0

# Use emacs key bindings in tmux command prompt (status line)
set -g status-keys emacs


# Terminal Settings
# -----------------
# Enable 256 color support for better syntax highlighting
set -g default-terminal "screen-256color"

# Enable true color (24-bit) support for modern terminals
# This is especially important for iTerm2 and modern color schemes
set -ga terminal-overrides ",xterm-256color:Tc"
set -ga terminal-overrides ",screen-256color:Tc"

# iTerm2-specific terminal overrides for better integration
set -ga terminal-overrides ',*:Ss=\E[%p1%d q:Se=\E[2 q'

# Enable mouse support (useful for scrolling, pane selection, and resizing)
# tmux 2.1+ uses unified 'mouse' option
# Older versions use separate mode-mouse, mouse-select-pane, etc.
if-shell -b '[ "$(echo "$(tmux -V | cut -d" " -f2) >= 2.1" | bc 2>/dev/null)" = "1" ]' \
  "set -g mouse on" \
  "set -g mode-mouse on; set -g mouse-resize-pane on; set -g mouse-select-pane on; set -g mouse-select-window on"

# macOS Clipboard Integration
# ----------------------------
# Enable clipboard access in tmux (works with iTerm2)
set -g set-clipboard on

# Allow programs in tmux to access the clipboard
set -ga terminal-overrides ',*:Ms=\E]52;%p1%s;%p2%s\007'


# Session Management
# ------------------
# Increase scrollback buffer size from default 2000 to 50000 lines
set -g history-limit 50000

# Start window numbering at 1 instead of 0 (easier to reach on keyboard)
set -g base-index 1

# Start pane numbering at 1 instead of 0
setw -g pane-base-index 1

# Renumber windows sequentially when one is closed
set -g renumber-windows on

# Allow automatic renaming of windows based on running command
set -g allow-rename on


# Remote Session Optimization
# ----------------------------
# Aggressive resize: only constrain window size when actively viewing
# (prevents smaller terminal from constraining larger ones)
setw -g aggressive-resize on

# Monitor activity in windows
setw -g monitor-activity on

# Don't display activity messages in status line
set -g visual-activity off

# Display tmux messages for 3 seconds
set -g display-time 3000

# Refresh status bar every 15 seconds
set -g status-interval 15


# Key Bindings
# ------------
# Split panes with intuitive keys (| for vertical, - for horizontal)
# Also maintain current path when splitting
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Easy config reload without restarting tmux
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Don't detach tmux when killing a session
set -g detach-on-destroy off

# Emacs copy mode with clipboard integration
# --------------------------------------------
# Use emacs-style key bindings in copy mode (consistent with status-keys emacs)
setw -g mode-keys emacs

# Quick copy mode entry with Ctrl-o (no prefix needed)
bind -n C-o copy-mode

# Emacs-style copy bindings with macOS clipboard integration
# C-Space to begin selection, M-w to copy (standard emacs bindings)
bind -T copy-mode C-Space send-keys -X begin-selection
bind -T copy-mode C-@ send-keys -X begin-selection
bind -T copy-mode M-w send-keys -X copy-pipe-and-cancel 'pbcopy'
bind -T copy-mode C-w send-keys -X copy-pipe-and-cancel 'pbcopy'

# Mouse drag to select and copy to clipboard
bind -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'pbcopy'

# Double-click to select word and copy to clipboard
bind -T root DoubleClick1Pane select-pane \; copy-mode -M \; send-keys -X select-word \; send-keys -X copy-pipe-and-cancel 'pbcopy'

# Triple-click to select line and copy to clipboard
bind -T root TripleClick1Pane select-pane \; copy-mode -M \; send-keys -X select-line \; send-keys -X copy-pipe-and-cancel 'pbcopy'


# iTerm2 Control Mode Optimizations
# ----------------------------------
# These settings optimize the experience when using 'tmux -CC' mode
# Control Mode transforms tmux panes into native Mac windows

# Focus events enable better integration with iTerm2
set -g focus-events on

# Set window titles to help identify them in iTerm2
set -g set-titles on
set -g set-titles-string "#S:#W - #{pane_current_command}"


# Status Bar Configuration
# -------------------------
# Increase left side length for session name display
set -g status-left-length 40

# Display hostname, date, and time on right side
set -g status-right "#H | %Y-%m-%d %H:%M"
